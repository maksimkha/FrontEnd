<html lang="en"> 
  <head>
    <link rel='stylesheet' type='text/css' href='styles.css'>
    <title>Item - Agrexa</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://www.gstatic.com/firebasejs/8.6.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.1/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.1/firebase-storage.js"></script>
    <script src="connect.js"></script>
    <script>
      function on_load(){
        firebase.auth().onAuthStateChanged(user => {
          if (user) {
            lang = ""
            firebase.database().ref("users/" + user.uid + "/language").once('value', (snapshot) => {
              if (snapshot.exists()) {
                lang = snapshot.val();
                location.href = snapshot.val();
                if (snapshot.val() == "#ru" && document.getElementById("account").text == "Account"){ 
                  location.reload();
                }
                else if (snapshot.val() == "#en" && document.getElementById("account").text == "Аккаунт"){
                  location.reload();
                }
              } else {
                console.log("no lang written");
              }
            }).catch((error) => {
              console.error(error);
            });
            item_id = new URLSearchParams(window.location.search).get("id");
            bool_photo = true;
            firebase.database().ref("users/" + user.uid + "/owes/" + item_id).once('value', (snapshot) => {
              data = snapshot.val();
              names = document.getElementsByName("user_name");
              amounts = document.getElementsByName("user_amount");
              document.getElementById("event").value = data.event;
              document.getElementById(data.category).selected=true;
              document.getElementById(data.method).selected=true;
              document.getElementById("amount").value = data.amount;
              bool_photo = data.photo
              if (bool_photo){
                firebase.storage().ref("users/" + user.uid + "/owes/").child(item_id).getDownloadURL().then(function(url){
                  document.getElementById("photo").src = url;
                  console.log("hooray");
                }).catch(function(error) {
                  console.error(error);
                });
              }
              i = 0;
              for (const [key, value] of Object.entries(data.owes)) {
                if (i > 1){
                  div = document.createElement('div');
                  div.className = "page-form__line-container"
                  div.innerHTML = "<input readonly name='user_name'><label>-</label><input type='number' readonly name='user_amount'>";
                  btn_line = document.getElementById("btn_line");
                  form = document.getElementById("page-form");
                  form.insertBefore(div, btn_line);
                }
                names[i].value = key;
                amounts[i].value = value;
                i++;
              }
            });
          } else {
            console.log("hey, leave this page!");
          }
        });
      }
      window.onload = on_load;
    </script>
    <script>
      function delete_item(){
        user = firebase.auth().currentUser;
        item_id = new URLSearchParams(window.location.search).get("id");
        firebase.database().ref("users/" + user.uid + "/owes/" + item_id).remove();
        window.location.href = "index.html";
      }
    </script>
    <script>
      function edit_item(){
        user = firebase.auth().currentUser;
        item_id = new URLSearchParams(window.location.search).get("id");
        btn = document.getElementById("edit_btn");
        names = document.getElementsByName("user_name");
        amounts = document.getElementsByName("user_amount");
        if (btn.textContent == language.en.edit || btn.textContent == language.ru.edit){
          btn.textContent="Save"
          document.getElementById("event").readOnly = false;
          document.getElementById("category").disabled = false;
          document.getElementById("amount").readOnly = false;
          document.getElementById("method").readOnly = false;
          for (i = 0; i < names.length; i++){
            names[i].readOnly = false;
            amounts[i].readOnly = false;
          }
        }
        else{
          btn.textContent="Edit"
          document.getElementById("event").readOnly = true;
          document.getElementById("category").disabled = true;
          document.getElementById("amount").readOnly = true;
          document.getElementById("method").readOnly = true;
          for (i = 0; i < names.length; i++){
            names[i].readOnly = true;
            amounts[i].readOnly = true;
          }
          medium_amount = document.getElementById("amount").value / (names.length);
          dict = {};
          for (i = 0; i < names.length; i++){
            dict[names[i].value] = amounts[i].value;
          }
          sign = '';
          if (amounts[0].value > medium_amount){
            sign = '+';
          }
          else{
            sign = '-';
          }
          category_opt = document.getElementById("category")
          method_opt = document.getElementById("method")
          firebase.database().ref("users/" + user.uid + "/owes/" + item_id).set({
            event: document.getElementById("event").value,
            category: category_opt.options[category_opt.selectedIndex].id,
            amount: document.getElementById("amount").value,
            method: method_opt.options[method_opt.selectedIndex].id,
            owes: dict,
            sign: sign,
            difference: Math.abs(medium_amount - amounts[0].value)
          });
          window.location.href = "index.html";
        }
      }
    </script>
    <script>
      function paid_method() {
        method = document.getElementById("method").value;
        names = document.getElementsByName("user_name");
        amounts = document.getElementsByName("user_amount");
        if (btn.textContent == language.en.save || btn.textContent == language.ru.save){
          if (method == "Equal" || method == "Поравну"){
            medium_amount = document.getElementById("amount").value / (names.length);
            for (i = 0; i < amounts.length; i++){
              amounts[i].value = medium_amount;
              amounts[i].readOnly = true;
            }
          }
          else if (method == "Amounts" || method == "Величины"){
            for (i = 0; i < amounts.length; i++){
              amounts[i].readOnly = false;
            }
          }
        }
      }
    </script>
  </head>
  <body>
    <header>
      <div class="topbar">
        <div>
          <label class="switch">
            <input type="checkbox" id="togBtn" onclick="change_lng()">
            <div class="slider round"></div>
          </label>
          <script>
            function change_lng(){
              user = firebase.auth().currentUser;
              btn = document.getElementById("togBtn");
              if (btn.checked == true){
                location.href = hash = "#ru";
              }
              else{
                location.href = hash ="#en";
              }
              firebase.database().ref("users/" + user.uid + "/language/").set(hash);
              location.reload();
            }
          </script>
        </div><!-- 
        --><div>
          <a href="index.html" class="topbar__site-name">Agrexa</a>
        </div><!-- 
      --><div>
          <a href="signup.html" class="topbar__account" id='account'>Account</a>
          </div>
      </div>
    </header>
    <main>
      <div class="pagebar">
        <h1 id="owe_h">Owe page
      </div>
        <form class="page-form" id="page-form">
          <div class="page-form__line-container">
              <label id="event_label">Event:</label>
              <input type="text" readonly id="event">
          </div>
          <div class="page-form__line-container">
            <label id="category_label">Category:</label>
            <select name="category" id="category" disabled>
              <option id="category_1">Entertaiment</option>
              <option id="category_2">Food and drink</option>
              <option id="category_3">Home</option>
              <option id="category_4">Life</option>
              <option id="category_5">Utility</option>
              <option id="category_6">Others</option>
            </select>
          </div>
          <div class="page-form__line-container">
              <label id="check_amount_label">Check amount:</label>
              <input type="number" readonly id="amount">
          </div>
          <div class="page-form__line-container">
              <label id="photo_label">Photo(opt.):</label>
              <img id="photo" height="250vh">
          </div>
          <div class="page-form__line-container">
            <label id="method_label">Split method:</label>
            <select name="method" id="method" disabled onchange="paid_method()">
              <option id="method_1">Amounts</option>
              <option id="method_2">Equal</option>
            </select>
          </div>
          <div class="page-form__line-container">
            <input readonly name="user_name">
            <label>-</label>
            <input type="number" readonly name="user_amount">
          </div>
          <div class="page-form__line-container">
            <input readonly name="user_name">
            <label>-</label>
            <input type="number" readonly name="user_amount">
          </div>
          <div class="page-form__line-container" id="btn_line">
            <button onclick="edit_item();return false;" id="edit_btn">Edit</button>
            <button onclick="delete_item();return false;" id="delete_btn">Delete</button>
          </div>
        </form>
      <script>
        function change_category_options(lang){
          cat_select = document.getElementById("category");
          met_select = document.getElementById("method");
          if (lang == 'en'){
            ans = language.en.category_opt;
            methods = language.en.method_opt;
          }
          else{
            ans = language.ru.category_opt;
            methods = language.ru.method_opt;
          }
          i = 0
          for (const [key, value] of Object.entries(ans)) {
            cat_select.options[i].innerText = value;
            i++;
          }
          i = 0
          for (const [key, value] of Object.entries(methods)) {
            met_select.options[i].innerText = value;
            i++;
          }
        }
      </script>
      <script>
        language = {
          en: {
            "account": "Account",
            "owe_page": "Owe page",
            "event": "Event: ",
            "category": "Category: ",
            "check_amount": "Check amount: ",
            "photo": "Photo(opt.): ",
            "method": "Split method:",
            "edit": "Edit",
            "save": "Save",
            "delete": "Delete",
            "category_opt":{
              "entertaimant": "Entertaimant",
              "fnd": "Food and drink",
              "home": "Home",
              "life": "Life",
              "utility": "Utility",
              "others": "Others"
            },
            "method_opt":{
              "amounts": "Amounts",
              "equal": "Equal"
            }
          },
          ru: {
            "account": "Аккаунт",
            "owe_page": "Страница траты",
            "event": "Событие: ",
            "category": "Категория: ",
            "check_amount": "Счет: ",
            "photo": "Фото(опц.): ",
            "method": "Дележка: ",
            "edit": "Изменить",
            "save": "Сохранить",
            "delete": "Удалить",
            "category_opt":{
              "entertaimant": "Развлечение",
              "fnd": "Еда и напитки",
              "home": "Дом",
              "life": "Жизнь",
              "utility": "Утилити",
              "others": "Другое"
            },
            "method_opt":{
              "amounts": "Величины",
              "equal": "Поравну"
            }
          }
        };
        if (window.location.hash){
          console.log(window.location.hash);
          if (window.location.hash == "#ru"){
            document.getElementById("togBtn").checked = true;
            document.getElementById("account").text = language.ru.account;
            document.getElementById("owe_h").innerHTML = language.ru.owe_page;
            document.getElementById("event_label").innerHTML = language.ru.event;
            document.getElementById("category_label").innerHTML = language.ru.category;
            document.getElementById("check_amount_label").innerHTML = language.ru.owe_page;
            document.getElementById("photo_label").innerHTML = language.ru.owe_page;
            document.getElementById("method_label").innerHTML = language.ru.method;
            document.getElementById("edit_btn").innerHTML = language.ru.edit;
            document.getElementById("delete_btn").innerHTML = language.ru.delete;
            change_category_options('ru');
          }
          else{
            document.getElementById("togBtn").checked = false;
            document.getElementById("account").text = language.en.account;
            document.getElementById("owe_h").innerHTML = language.en.owe_page;
            document.getElementById("event_label").innerHTML = language.en.event;
            document.getElementById("category_label").innerHTML = language.en.category;
            document.getElementById("check_amount_label").innerHTML = language.en.check_amount;
            document.getElementById("photo_label").innerHTML = language.en.photo;
            document.getElementById("method_label").innerHTML = language.en.method;
            document.getElementById("edit_btn").innerHTML = language.en.edit;
            document.getElementById("delete_btn").innerHTML = language.en.delete;
            change_category_options('en');
          }
        }
      </script>
    </main>
    <footer>
      <h3>Khatskevich, 2021
    </footer>
  </body>
</html>