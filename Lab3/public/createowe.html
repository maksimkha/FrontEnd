<html> 
  <head>
    <link rel='stylesheet' type='text/css' href='styles.css'>
    <title>Create - Agrexa</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://www.gstatic.com/firebasejs/8.6.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.1/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.1/firebase-auth.js"></script>
    <script src="connect.js"></script>
    <script>
      function on_load(){
        link = document.getElementById('account');
        firebase.auth().onAuthStateChanged(user => {
          if (user) {
              link.href = 'account.html';
            } else {
              const googleAuth = new firebase.auth.GoogleAuthProvider();
              firebase.auth().signInWithPopup(googleAuth);
          }
        });
      }
      window.onload = on_load;
    </script>
    <script>
      function save_owe() {
        user = firebase.auth().currentUser;
        names = document.getElementsByName("user_name");
        amounts = document.getElementsByName("user_amount");
        medium_amount = document.getElementById("amount").value / (names.length);
        dict = {};
        for (i = 0; i < names.length; i++){
          dict[names[i].value] = amounts[i].value;
        }
        sign = '';
        if (amounts[0].value > medium_amount){
          sign = '+';
        }
        else{
          sign = '-';
        }
        if (user) {
          firebase.database().ref('users/'+user.uid+'/owes').push({
            event: document.getElementById("event").value,
            category: document.getElementById("category").value,
            amount: document.getElementById("amount").value,
            method: document.getElementById("method").value,
            owes: dict,
            sign: sign,
            difference: Math.abs(medium_amount - amounts[0].value)
          });
          } else {
            alert("log in first!")
          }
          window.location.href = "index.html";
      }
    </script>
    <script>
      function add_input() {
        method = document.getElementById("method").value;
        const div = document.createElement('div');
        div.className = "create-form__line-container"
        if (method == "Equal"){
          div.innerHTML = "<input><label name='user_name'>pays</label><input name='user_amount'  type='number' value=0 readonly>";
        }
        else{
          div.innerHTML = "<input><label name='user_name'>pays</label><input name='user_amount'  type='number'>";
        }
        saveBtn = document.getElementById("saveBtn");
        form = document.getElementById("create-form");
        form.insertBefore(div, saveBtn);
      }
    </script>
    <script>
      function delete_input() {
        divs = document.getElementsByClassName("create-form__line-container");
        to_del = divs[divs.length - 1];
        if (divs.length > 8)
          to_del.remove();
      }
    </script>
    <script>
      function paid_method() {
        method = document.getElementById("method").value;
        divs = document.getElementsByName("user_amount");
        if (method == "Equal"){
          for (i = 0; i < divs.length; i++){
            divs[i].value = 0;
            divs[i].readOnly = true;
          }
        }
        else{
          for (i = 0; i < divs.length; i++){
            divs[i].readOnly = false;
            divs[i].value = '';
          }
        }
      }
    </script>
  </head>
  <body>
    <header>
      <div class="topbar">
        <div>
          <label class="switch">
            <input type="checkbox" id="togBtn">
            <div class="slider round"></div>
          </label>
        </div><!-- 
      --><div>
            <a href="index.html" class="topbar__site-name">Agrexa</a>
            </div><!-- 
          --><div>
              <a href="signup.html" class="topbar__account" id='account'>Account</a>
          </div>
      </div>
    </header>
    <main>
      <div class="pagebar">
        <h1>Add an expence
      </div>
      <form class="create-form" id="create-form">
        <div class="create-form__line-container">
            <label>Event:</label>
            <input type="text" name="event" id="event">
        </div>
        <div class="create-form__line-container">
            <label>Category:</label>
            <select name="category" id="category">
                <option>Entertaiment</option>
                <option>Food and drink</option>
                <option>Home</option>
                <option>Life</option>
                <option>Utility</option>
                <option>Others</option>
            </select>
        </div>
        <div class="create-form__line-container">
            <label>Check amount:</label>
            <input type="number" name="amount" id="amount">
        </div>
        <div class="create-form__line-container">
            <label>Photo(opt.):</label>
            <input type="file" name="photo" id="photo" accept=".jpg,.jpeg,.png">
        </div>
        <div class="create-form__line-container">
            <label>Split method:</label>
            <select name="method" id="method" onchange="paid_method()">
              <option>Amounts</option>
              <option>Equal</option>
            </select>
        </div>
        <div class="create-form__line-container">
          <button name="addition" id="addition" onclick="add_input();return false;">Add</button>
          <button name="delete" id="delete" onclick="delete_input();return false;">Delete</button>
        </div>
        <div class="create-form__line-container">
          <input name="user_name" value="I" readonly>
          <label>paid</label>
          <input name="user_amount" type="number">
        </div>
        <div class="create-form__line-container">
          <input name="user_name">
          <label>pays</label>
          <input name="user_amount" type="number">
        </div>
        <button onclick="save_owe();return false;" id="saveBtn">Save</button>
      </form>
    </main>
    <footer>
      <h3>Khatskevich, 2021
    </footer>
  </body>
</html>